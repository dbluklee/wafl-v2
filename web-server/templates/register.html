{% extends "base.html" %}

{% block title %}매장 등록 - WAFL{% endblock %}

{% block content %}
<div class="px-4 py-8">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white rounded-lg shadow-sm border p-8">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">매장 등록</h1>
                <p class="text-gray-600">네이버 스토어 정보를 스크래핑하기 위해 매장 정보를 입력해주세요.</p>
            </div>

            <form id="register-form" class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="store_name" class="block text-sm font-medium text-gray-700 mb-2">
                            매장명 <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="store_name" name="store_name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               placeholder="매장 이름을 입력하세요">
                    </div>

                    <div>
                        <label for="owner_name" class="block text-sm font-medium text-gray-700 mb-2">
                            대표자명 <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="owner_name" name="owner_name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               placeholder="대표자 이름을 입력하세요">
                    </div>
                </div>

                <div>
                    <label for="store_address" class="block text-sm font-medium text-gray-700 mb-2">
                        매장 주소 <span class="text-red-500">*</span>
                    </label>
                    <div class="flex gap-2">
                        <input type="text" id="store_address" name="store_address" required readonly
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 bg-gray-50"
                               placeholder="주소 검색 버튼을 클릭하세요">
                        <button type="button" onclick="openJusoPopup();"
                                class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors whitespace-nowrap">
                            주소 검색
                        </button>
                    </div>
                    <input type="text" id="store_address_detail" name="store_address_detail"
                           class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="상세 주소를 입력하세요 (선택사항)">
                    <input type="hidden" id="zipNo" name="zipNo">
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="business_number" class="block text-sm font-medium text-gray-700 mb-2">
                            사업자등록번호 <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="business_number" name="business_number" required
                               pattern="[0-9]{3}-[0-9]{2}-[0-9]{5}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               placeholder="000-00-00000">
                    </div>

                    <div>
                        <label for="owner_phone" class="block text-sm font-medium text-gray-700 mb-2">
                            대표 전화번호 <span class="text-red-500">*</span>
                        </label>
                        <input type="tel" id="owner_phone" name="owner_phone" required
                               pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               placeholder="010-0000-0000">
                    </div>
                </div>

                <div>
                    <label for="naver_store_url" class="block text-sm font-medium text-gray-700 mb-2">
                        네이버 스토어 링크 <span class="text-red-500">*</span>
                    </label>
                    <input type="url" id="naver_store_url" name="naver_store_url" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="https://naver.me/... 또는 https://map.naver.com/...">
                    <p class="mt-1 text-sm text-gray-500">
                        네이버 지도에서 매장을 검색한 후 공유 링크를 붙여넣어 주세요.
                    </p>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">안내사항</h3>
                            <div class="mt-2 text-sm text-blue-700">
                                <ul class="list-disc list-inside space-y-1">
                                    <li>등록 후 스크래핑 작업이 자동으로 시작됩니다.</li>
                                    <li>스크래핑 완료까지 5-10분 정도 소요될 수 있습니다.</li>
                                    <li>입력한 정보와 스크래핑된 정보가 다를 경우 확인 알림을 받습니다.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 pt-6 border-t">
                    <a href="/"
                       class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                        취소
                    </a>
                    <button type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                            id="submit-btn">
                        등록하기
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 주소 검색 팝업 열기
function openJusoPopup() {
    window.open("/jusoPopup", "pop", "width=570,height=420,scrollbars=yes,resizable=yes");
}

// 주소 검색 팝업에서 호출하는 콜백 함수
function jusoCallBack(roadFullAddr, roadAddrPart1, addrDetail, roadAddrPart2, engAddr,
                      jibunAddr, zipNo, admCd, rnMgtSn, bdMgtSn, detBdNmList, bdNm,
                      bdKdcd, siNm, sggNm, emdNm, liNm, rn, udrtYn, buldMnnm,
                      buldSlno, mtYn, lnbrMnnm, lnbrSlno, emdNo) {
    // 도로명 주소를 메인 주소 필드에 설정
    document.getElementById('store_address').value = roadAddrPart1;
    document.getElementById('zipNo').value = zipNo;

    // 팝업에서 입력한 상세주소가 있으면 설정
    if (addrDetail) {
        document.getElementById('store_address_detail').value = addrDetail;
    }

    // 상세주소 필드에 포커스 (상세주소가 없는 경우 추가 입력 가능)
    document.getElementById('store_address_detail').focus();
}

document.getElementById('register-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.textContent;

    // 버튼 비활성화
    submitBtn.disabled = true;
    submitBtn.textContent = '등록 중...';

    try {
        const formData = new FormData(this);

        // 주소는 기본 도로명 주소만 저장 (상세주소 제외)
        // 상세주소는 네이버에도 없으므로 비교 시 제외해야 함
        const baseAddress = document.getElementById('store_address').value;
        formData.set('store_address', baseAddress);

        const response = await fetch('/api/stores/register', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            showToast('success', '매장이 성공적으로 등록되었습니다!');
            // 3초 후 대시보드로 이동
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 2000);
        } else {
            showToast('error', result.detail || '등록 중 오류가 발생했습니다.');
        }
    } catch (error) {
        showToast('error', '네트워크 오류가 발생했습니다.');
    } finally {
        // 버튼 활성화
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});

// 사업자등록번호 자동 포맷팅
document.getElementById('business_number').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^0-9]/g, '');
    if (value.length > 10) value = value.slice(0, 10);

    if (value.length >= 6) {
        value = value.slice(0, 3) + '-' + value.slice(3, 5) + '-' + value.slice(5);
    } else if (value.length >= 4) {
        value = value.slice(0, 3) + '-' + value.slice(3);
    }

    e.target.value = value;
});

// 전화번호 자동 포맷팅
document.getElementById('owner_phone').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^0-9]/g, '');
    if (value.length > 11) value = value.slice(0, 11);

    if (value.length >= 7) {
        if (value.startsWith('02')) {
            value = value.slice(0, 2) + '-' + value.slice(2, 6) + '-' + value.slice(6);
        } else {
            value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7);
        }
    } else if (value.length >= 4) {
        if (value.startsWith('02')) {
            value = value.slice(0, 2) + '-' + value.slice(2);
        } else {
            value = value.slice(0, 3) + '-' + value.slice(3);
        }
    }

    e.target.value = value;
});
</script>
{% endblock %}